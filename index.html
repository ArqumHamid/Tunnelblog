<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Tunnel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: black; }
    </style>
</head>
<body>
    <script>
        let urlParams = new URLSearchParams(window.location.search);
        let musicUrl = urlParams.get("music");
        let audio, audioContext, analyser;

        function startMusic() {
            if (!musicUrl) return;
            audio = new Audio(musicUrl);
            audio.loop = true;
            audio.play();

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            let source = audioContext.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
        }

        // 3D Tunnel (Like Tunnel Rush)
        let scene = new THREE.Scene();
        let camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        let renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        let tunnelMaterial = new THREE.MeshBasicMaterial({ wireframe: true });
        let tunnelGeometry = new THREE.CylinderGeometry(5, 5, 100, 32, 1, true);
        let tunnel = new THREE.Mesh(tunnelGeometry, tunnelMaterial);
        scene.add(tunnel);

        camera.position.z = 5;

        function animate() {
            requestAnimationFrame(animate);

            // Create high-speed tunnel rush effect
            tunnel.rotation.z += 0.01;
            tunnel.position.z -= 0.2;

            // Dynamic Visuals Based on Music
            if (analyser) {
                let dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                let avgFreq = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                tunnel.scale.x = tunnel.scale.y = 1 + (avgFreq * 0.002);
                tunnelMaterial.color.setHSL(Math.random(), 1, 0.5);
            }

            renderer.render(scene, camera);
        }

        startMusic();
        animate();

        // Prevent screen from sleeping
        let wakeLock = null;
        async function keepScreenAwake() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {
                    console.log("Wake lock error:", err);
                }
            }
        }
        keepScreenAwake();

        window.addEventListener("resize", function() {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        });
    </script>
</body>
</html>
